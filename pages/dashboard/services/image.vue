<template>
  <div>
    <h2>راه اندازی سرویس</h2>
    <div class="row">
      <div class="col-md-6 col-xs-12">
        <wizard btn_title="مرحله بعد">
          <div class="fandogh-form-group">
            <f-radio v-model="image_type" :options="image_types" title="نوع ایمیج"/>
          </div>
          <a
            v-if="!images.length && !loading"
            href="https://docs.fandogh.cloud/docs/getting-started.html"
            target="_blank"
          >
            <f-label
              value="شما هیچ تصویری پابلیش نکرده اید٬ برای آپلود کردن تصویر می توانید از این لینک  استفاده کنید."
            />
          </a>
          <div v-if="internal" class="row">
            <div class="col-sm-8 col-xs-12">
              <div class="fandogh-form-group">
                <label>نام ایمیج</label>
                <f-select
                  tabindex="1"
                  v-model="image"
                  title="نام ایمیج را انتخاب کنید"
                  :options="images"
                  styles="input-white input-block input-dashboard"
                  placeholder="نام ایمیج را انتخاب کنید"
                ></f-select>
              </div>
            </div>
            <div class="col-sm-4 col-xs-12">
              <div class="fandogh-form-group">
                <label>ورژن ایمیج</label>
                <f-select
                  tabindex="2"
                  v-model="version"
                  title="ورژن "
                  :options="versions"
                  styles="input-white input-block input-dashboard"
                  placeholder="ورژن ایمیج را انتخاب کنید"
                ></f-select>
              </div>
            </div>
          </div>

          <div v-else class="row">
            <div class="col-sm-8 col-xs-12">
              <div class="fandogh-form-group">
                <label>نام یا آدرس ایمیج</label>
                <f-input
                  v-model="image_external"
                  styles="input-white input-block input-dashboard"
                  placeholder="نام ایمیج خارجی بنویسید"
                ></f-input>
              </div>
            </div>
            <div class="col-sm-4 col-xs-12">
              <div class="fandogh-form-group">
                <label>ورژن ایمیج</label>
                <f-input
                  v-model="version_external"
                  styles="input-white input-block input-dashboard"
                  placeholder="آخرین ورژن"
                ></f-input>
              </div>
            </div>
          </div>

          <div class="fandogh-form-group">
            <label>Replicas</label>
            <f-input
              v-model="replicas"
              styles="input-white input-block input-dashboard"
              type="number"
              placeholder="تعداد رپلیکاها را در این قسمت بنویسید"
            ></f-input>
          </div>

          <div class="fandogh-form-group" v-if="image_type === 'خارجی'">
            <label>Image Pull Policy</label>
            <f-select
              tabindex="3"
              v-model="image_pull_policy"
              :isClear="true"
              styles="input-white input-block input-dashboard"
              :options="[{title: 'Always'}, {title: 'IfNotPresent'}]"
              placeholder="Image Pull Policy"
            ></f-select>
          </div>

          <div class="fandogh-form-group" v-if="image_type === 'خارجی'">
            <label>Image Pull Secret</label>
            <f-select
              tabindex="2"
              v-model="image_pull_secret"
              title="Image Pull Secret"
              :options="secretList"
              styles="input-white input-block input-dashboard"
              placeholder="Image Pull Secret "
            ></f-select>
          </div>
        </wizard>
      </div>
    </div>
  </div>
</template>

<script>
import FInput from "~/components/elements/input";
import FButton from "~/components/elements/button";
import FTable from "~/components/Dashboard/table";
import FCheckbox from "~/components/elements/checkbox";
import FSelect from "~/components/elements/select";
import FLabel from "~/components/Dashboard/label";
import Wizard from "~/components/Dashboard/wizard";
import FRadio from "~/components/elements/radio";
import { getValue } from "~/utils/cookie";

// yaml generator
import jsyaml from "js-yaml";

export default {
  data() {
    return {
      replicas: "",
      image: "",
      image_external: "",
      version_external: "latest",
      version_loaded: false,
      version: "",
      image_type: "",
      image_pull_policy: "",
      image_pull_secret: "",
      image_types: ["داخلی فندق", "خارجی"]
    };
  },

  computed: {
    loading() {
      return this.$store.state.loading;
    },
    secretList() {
      return this.$store.state.secrets.map(item => {
        return {
          title: item.name,
          value: item.name
        };
      });
    },
    nameImage() {
      return getValue("name");
    },
    versionsImage() {
      return getValue("versions");
    },
    internal() {
      return this.image_types[0] === this.image_type;
    },
    images() {
      if (!this.$store.state.images) return [];
      return this.$store.state.images.map(item => {
        return {
          title: item.name,
          value: item.name
        };
      });
    },
    versions() {
      if (!this.$store.state.versions) return [];
      return this.$store.state.versions.map(item => {
        return {
          title: item.version,
          value: item.version
        };
      });
    },
    imageVersion() {
      if (
        (!this.image.length || !this.version.length) &&
        (!this.image_external.length || !this.version_external.length)
      )
        return;
      return this.internal
        ? this.image + ":" + this.version
        : this.image_external + ":" + this.version_external;
    }
  },
  layout: "dashboard",
  watch: {
    image(value, oldValue) {
      this.version_loaded = false;
      //this.version = ''
      let imageAndVersion = value.split(":");
      if (imageAndVersion.length > 1) {
        this.image = imageAndVersion[0];
        this.$store.dispatch("getImageVersions", this.image).then(res => {
          this.version_loaded = true;
          this.version = imageAndVersion[1];
        });
      } else {
        this.$store.dispatch("getImageVersions", value).then(res => {
          this.version_loaded = true;
        });
      }
    },
    imageVersion(value) {
      this.$store.dispatch("manifestGenerator", { value, path: "spec.image" });
    },
    replicas(value, oldValue) {
      this.$store.dispatch("manifestGenerator", {
        value,
        path: "spec.replicas"
      });
    },
    image_pull_policy(value, oldValue) {
      this.$store.dispatch("manifestGenerator", {
        value,
        path: "spec.image_pull_policy"
      });
    },
    image_pull_secret(value, oldValue) {
      this.$store.dispatch("manifestGenerator", {
        value,
        path: "spec.image_pull_secret"
      });
    }
  },

  created() {
    this.getData();
  },
  methods: {
    async getData() {
      try {
        await this.$store.dispatch("getImages");
        this.$store.commit("SET_DATA", { data: false, id: "loading" });
      } catch (e) {
        if (e.status === 401) {
          this.$router.push("/user/login");
        }
        this.$store.commit("SET_DATA", { data: false, id: "loading" });
      }
    },
    nextStep() {
      this.$router.push("/dashboard/services/create/step3");
    }
  },
  components: {
    FInput,
    FButton,
    FCheckbox,
    FTable,
    FSelect,
    FLabel,
    Wizard,
    FRadio
  },
  mounted() {
    if (this.nameImage) {
      this.image = this.nameImage;
      this.version = this.versionsImage;
    }
    this.$store.dispatch("getSecret");
  }
};
</script>

<style scoped lang="stylus">
.field-description
  color #b5b5b5
  font-size 14px
</style>